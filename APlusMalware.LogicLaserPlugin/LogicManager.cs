using System;
using System.Collections.Generic;
using APlusMalware.ByteLogic;
using UnityEngine;

namespace APlusMalware.LogicLaserPlugin
{
    public class LogicManager : FortressCraftMod
    {
        private delegate SegmentEntity EntityConstructor(
            Segment segment, Int64 x, Int64 y, Int64 z, UInt16 cubeType, Byte flags, UInt16 value);

        private readonly Dictionary<String, EntityConstructor> _constructors;

        public static LogicManager Instance { get; private set; }

        public Graph Graph { get; }

        public LogicManager()
        {
            Graph = new Graph();
            _constructors = new Dictionary<String, EntityConstructor>();

            // Populate key-delegate dictionary
            _constructors.Add("APlusMalware.LogicLasers.Repeater",
                delegate (Segment segment, Int64 x, Int64 y, Int64 z, UInt16 cubeType, Byte flags, UInt16 value)
                { return new LogicLaserRepeater(segment, x, y, z, cubeType, flags, value); });

            _constructors.Add("APlusMalware.LogicLasers.Inverter",
                delegate (Segment segment, Int64 x, Int64 y, Int64 z, UInt16 cubeType, Byte flags, UInt16 value)
                { return new LogicLaserInverter(segment, x, y, z, cubeType, flags, value); });

            _constructors.Add("APlusMalware.LogicLasers.Splitter",
                delegate (Segment segment, Int64 x, Int64 y, Int64 z, UInt16 cubeType, Byte flags, UInt16 value)
                { return new LogicSplitter(segment, x, y, z, cubeType, flags, value); });

            _constructors.Add("APlusMalware.LogicLasers.MaxSelector",
                delegate (Segment segment, Int64 x, Int64 y, Int64 z, UInt16 cubeType, Byte flags, UInt16 value)
                { return new LogicLaserMaxSelector(segment, x, y, z, cubeType, flags, value); });

            _constructors.Add("APlusMalware.LogicLasers.Adder",
                delegate (Segment segment, Int64 x, Int64 y, Int64 z, UInt16 cubeType, Byte flags, UInt16 value)
                { return new LogicLaserAdder(segment, x, y, z, cubeType, flags, value); });

            _constructors.Add("APlusMalware.LogicLasers.OverflowChecker",
                delegate (Segment segment, Int64 x, Int64 y, Int64 z, UInt16 cubeType, Byte flags, UInt16 value)
                { return new LogicLaserOverflowChecker(segment, x, y, z, cubeType, flags, value); });

            _constructors.Add("APlusMalware.LogicLasers.EqualityChecker",
                delegate (Segment segment, Int64 x, Int64 y, Int64 z, UInt16 cubeType, Byte flags, UInt16 value)
                { return new LogicLaserEqualityChecker(segment, x, y, z, cubeType, flags, value); });

            _constructors.Add("APlusMalware.LogicLasers.Downscaler",
                delegate (Segment segment, Int64 x, Int64 y, Int64 z, UInt16 cubeType, Byte flags, UInt16 value)
                { return new LogicLaserDownscaler(segment, x, y, z, cubeType, flags, value); });

            _constructors.Add("APlusMalware.LogicLasers.Upscaler",
                delegate (Segment segment, Int64 x, Int64 y, Int64 z, UInt16 cubeType, Byte flags, UInt16 value)
                { return new LogicLaserUpscaler(segment, x, y, z, cubeType, flags, value); });

            _constructors.Add("APlusMalware.LogicLasers.PowerSensor",
                delegate (Segment segment, Int64 x, Int64 y, Int64 z, UInt16 cubeType, Byte flags, UInt16 value)
                { return new LogicPowerSensor(segment, x, y, z, cubeType, flags, value); });

            _constructors.Add("APlusMalware.LogicLasers.ConveyorSensor",
                delegate (Segment segment, Int64 x, Int64 y, Int64 z, UInt16 cubeType, Byte flags, UInt16 value)
                { return new LogicPowerSensor(segment, x, y, z, cubeType, flags, value); });

            _constructors.Add("APlusMalware.LogicLasers.StorageSensor",
                delegate (Segment segment, Int64 x, Int64 y, Int64 z, UInt16 cubeType, Byte flags, UInt16 value)
                { return new LogicPowerSensor(segment, x, y, z, cubeType, flags, value); });

            _constructors.Add("APlusMalware.LogicLasers.CphSensor",
                delegate (Segment segment, Int64 x, Int64 y, Int64 z, UInt16 cubeType, Byte flags, UInt16 value)
                { return new LogicPowerSensor(segment, x, y, z, cubeType, flags, value); });

            _constructors.Add("APlusMalware.LogicLasers.LiftSensor",
                delegate (Segment segment, Int64 x, Int64 y, Int64 z, UInt16 cubeType, Byte flags, UInt16 value)
                { return new LogicPowerSensor(segment, x, y, z, cubeType, flags, value); });

            _constructors.Add("APlusMalware.LogicLasers.ThreatSensor",
                delegate (Segment segment, Int64 x, Int64 y, Int64 z, UInt16 cubeType, Byte flags, UInt16 value)
                { return new LogicPowerSensor(segment, x, y, z, cubeType, flags, value); });

            _constructors.Add("APlusMalware.LogicLasers.MinecartSensor",
                delegate (Segment segment, Int64 x, Int64 y, Int64 z, UInt16 cubeType, Byte flags, UInt16 value)
                { return new LogicPowerSensor(segment, x, y, z, cubeType, flags, value); });

            _constructors.Add("APlusMalware.LogicLasers.CrystalClockSensor",
                delegate (Segment segment, Int64 x, Int64 y, Int64 z, UInt16 cubeType, Byte flags, UInt16 value)
                { return new LogicPowerSensor(segment, x, y, z, cubeType, flags, value); });

            _constructors.Add("APlusMalware.LogicLasers.ThreatLevelSensor",
                delegate (Segment segment, Int64 x, Int64 y, Int64 z, UInt16 cubeType, Byte flags, UInt16 value)
                { return new LogicPowerSensor(segment, x, y, z, cubeType, flags, value); });

            _constructors.Add("APlusMalware.LogicLasers.LptReceiver",
                delegate (Segment segment, Int64 x, Int64 y, Int64 z, UInt16 cubeType, Byte flags, UInt16 value)
                { return new LogicLptReceiver(segment, x, y, z, cubeType, flags, value); });

            _constructors.Add("APlusMalware.LogicLasers.ConveyorReceiver",
                delegate (Segment segment, Int64 x, Int64 y, Int64 z, UInt16 cubeType, Byte flags, UInt16 value)
                { return new LogicConveyorReceiver(segment, x, y, z, cubeType, flags, value); });

            _constructors.Add("APlusMalware.LogicLasers.TeleporterReceiver",
                delegate (Segment segment, Int64 x, Int64 y, Int64 z, UInt16 cubeType, Byte flags, UInt16 value)
                { return new LogicTeleporterReceiver( segment, x, y, z, cubeType, flags, value); });

            if (Instance == null) Instance = this;
        }

        public override ModRegistrationData Register()
        {
            var data = new ModRegistrationData();
            foreach (String key in _constructors.Keys)
                data.RegisterEntityHandler(key);
            return data;
        }

        public override void LowFrequencyUpdate()
        {
            Graph.Step();
        }

        public override void CreateSegmentEntity(ModCreateSegmentEntityParameters parameters, ModCreateSegmentEntityResults results)
        {
            var data = TerrainData.mEntries[parameters.Cube];
            EntityConstructor ctor;
            if (!_constructors.TryGetValue(data.Key, out ctor))
            {
                TerrainDataValueEntry value = data.GetValue(parameters.Value);
                if (value == null || !_constructors.TryGetValue(value.Key, out ctor))
                {
                    Debug.LogWarning($"LogicLasers CreateSegmentEntity called with unrecognized parameters? Cube: {parameters.Cube} Value {parameters.Value}");
                    return;
                }
            }
            results.Entity = ctor(parameters.Segment, parameters.X, parameters.Y, parameters.Z, parameters.Cube, parameters.Flags, parameters.Value);
        }
    }
}

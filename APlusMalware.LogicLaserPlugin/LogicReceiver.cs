using System;
using System.Linq;
using APlusMalware.LogicGraph;
using UnityEngine;

namespace APlusMalware.LogicLaserPlugin
{
    public abstract class LogicReceiver : MachineEntity, ILogicReceiver
    {
        private readonly LogicNode<Byte> _node;
        private Boolean _addedToGraph;

        protected LogicReceiver(Segment segment, Int64 x, Int64 y, Int64 z, UInt16 cubeType, Byte flags, UInt16 value, LogicNode<Byte> node)
            : base(eSegmentEntity.Mod, SpawnableObjectEnum.LaserPressurePad, x, y, z, cubeType, flags, value, Vector3.zero, segment)
        {
            mbNeedsLowFrequencyUpdate = true;
            _node = node;
            UpdateFaces(flags);
        }

        protected virtual String Name { get; } = "Some Logic Receiver";

        protected SByte TargetXOffset { get; private set; }

        protected SByte TargetYOffset { get; private set; }

        protected SByte TargetZOffset { get; private set; }

        public abstract SByte FindFaceInputIndex(Byte direction);

        public LogicNode<Byte> GetLogicNode()
        {
            return _node;
        }

        public override String GetPopupText()
        {
            String inputs = String.Join(", ", _node.InputValues.Select(i => i.ToString()).ToArray());
            return $"{Name}\nInput: {inputs}";
        }

        public override void OnDelete()
        {
            ResetLogic();
            LogicManager.Instance.Graph.RemoveNode(_node);
            base.OnDelete();
            UpdateEntity(true); // Force a reset on the connected entity
        }

        public override void OnUpdateRotation(Byte flags)
        {
            base.OnUpdateRotation(flags);
            UpdateFaces(flags);
        }

        public override void LowFrequencyUpdate()
        {
            if (!_addedToGraph)
            {
                LogicManager.Instance.Graph.AddNode(_node);
                _addedToGraph = true;
            }

            UpdateEntity(false);
        }

        protected abstract void UpdateTarget(SegmentEntity entity, Byte[] inputValues, Boolean reset);

        private void UpdateEntity(Boolean forceReset)
        {
            Int64 targetX = mnX + TargetXOffset;
            Int64 targetY = mnY + TargetYOffset;
            Int64 targetZ = mnZ + TargetZOffset;
            Segment segment = AttemptGetSegment(targetX, targetY, targetZ);
            if (segment == null)
                return;

            UInt16 cubeType = segment.GetCube(targetX, targetY, targetZ);
            if (CubeHelper.HasEntity(cubeType))
            {
                SegmentEntity entity = segment.SearchEntity(targetX, targetY, targetZ);

                Boolean reset = _node.ActiveInputCount == 0; // Reset the entity to defaults if the node can't be set
                if (entity != null)
                    UpdateTarget(entity, _node.InputValues, reset || forceReset);
            }
        }

        private void UpdateFaces(Byte flags)
        {
            Vector3 vector = Vector3.Normalize(SegmentCustomRenderer.GetRotationQuaternion(flags) * Vector3.down);
            TargetXOffset = (SByte)vector.x;
            TargetYOffset = (SByte)vector.y;
            TargetZOffset = (SByte)vector.z;
        }
        
        private void ResetLogic()
        {
            _node.DisconnectAll();
        }
    }
}
